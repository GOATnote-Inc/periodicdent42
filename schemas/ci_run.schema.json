{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://goatnote.com/schemas/ci_run.schema.json",
  "title": "CI Run Schema",
  "description": "Schema for epistemic CI test execution data across materials, protein, and robotics domains",
  "definitions": {
    "Test": {
      "type": "object",
      "required": ["name", "suite", "domain", "duration_sec", "result", "cost_usd", "timestamp"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Fully qualified test name (e.g., tests/test_materials.py::test_lattice_stability)"
        },
        "suite": {
          "type": "string",
          "description": "Test suite grouping (e.g., materials, protein, robotics, integration)"
        },
        "domain": {
          "type": "string",
          "enum": ["materials", "protein", "robotics", "generic"],
          "description": "Scientific domain for this test"
        },
        "duration_sec": {
          "type": "number",
          "minimum": 0,
          "description": "Wall-clock execution time in seconds"
        },
        "result": {
          "type": "string",
          "enum": ["pass", "fail", "skip", "error"],
          "description": "Test outcome"
        },
        "failure_type": {
          "type": "string",
          "enum": ["assertion", "timeout", "exception", "segfault", "numerical", "flaky"],
          "description": "Failure classification if result is fail or error"
        },
        "metrics": {
          "type": "object",
          "description": "Domain-specific metrics (e.g., convergence error, binding affinity delta)",
          "additionalProperties": true
        },
        "model_uncertainty": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Predicted failure probability from ML model (0.0-1.0)"
        },
        "cost_usd": {
          "type": "number",
          "minimum": 0,
          "description": "Execution cost in USD"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp"
        },
        "eig_bits": {
          "type": "number",
          "description": "Expected Information Gain in bits (computed post-hoc)"
        },
        "entropy_before": {
          "type": "number",
          "description": "Entropy before test execution (bits)"
        },
        "entropy_after": {
          "type": "number",
          "description": "Entropy after test execution (bits)"
        }
      }
    },
    "CIRun": {
      "type": "object",
      "required": ["commit", "branch", "changed_files", "walltime_sec", "tests", "budget_sec"],
      "properties": {
        "commit": {
          "type": "string",
          "pattern": "^[a-f0-9]{40}$",
          "description": "Git commit SHA (40-char hex)"
        },
        "branch": {
          "type": "string",
          "description": "Git branch name"
        },
        "changed_files": {
          "type": "array",
          "items": {"type": "string"},
          "description": "List of files changed in this commit"
        },
        "lines_added": {
          "type": "integer",
          "minimum": 0,
          "description": "Lines added in diff"
        },
        "lines_deleted": {
          "type": "integer",
          "minimum": 0,
          "description": "Lines deleted in diff"
        },
        "walltime_sec": {
          "type": "number",
          "minimum": 0,
          "description": "Total CI run wall-clock time in seconds"
        },
        "cpu_sec": {
          "type": "number",
          "minimum": 0,
          "description": "Total CPU seconds consumed"
        },
        "mem_gb_sec": {
          "type": "number",
          "minimum": 0,
          "description": "Memory usage in GB-seconds"
        },
        "tests": {
          "type": "array",
          "items": {"$ref": "#/definitions/Test"},
          "description": "List of test executions in this run"
        },
        "budget_sec": {
          "type": "number",
          "minimum": 0,
          "description": "Time budget for test selection (seconds)"
        },
        "budget_usd": {
          "type": "number",
          "minimum": 0,
          "description": "Cost budget for test selection (USD)"
        },
        "runner_usd_per_hour": {
          "type": "number",
          "default": 0.60,
          "description": "CI runner cost per hour (USD)"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "CI run start timestamp"
        }
      }
    }
  },
  "oneOf": [
    {"$ref": "#/definitions/Test"},
    {"$ref": "#/definitions/CIRun"}
  ]
}
