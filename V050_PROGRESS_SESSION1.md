# v0.5.0 Accuracy Tuning - Session 1 Progress

## ‚úÖ COMPLETED (Steps 0-1)

### STEP 0: Branch & Scaffolding ‚úÖ
**Status**: 100% Complete

**Deliverables**:
- ‚úÖ Branch: `v0.5.0-accuracy-tuning` created
- ‚úÖ Directory structure: `app/src/htc/tuning/`, `tests/tuning/`, `config/`
- ‚úÖ Scaffold files created (9 files)
- ‚úÖ Dependencies added: `scikit-optimize==0.9.0` (pinned), `pyyaml>=6.0`

**Files Created**:
```
app/src/htc/tuning/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ allen_dynes_corrections.py  ‚úÖ IMPLEMENTED (220 lines)
‚îú‚îÄ‚îÄ mu_star_optimizer.py        ‚è≥ PENDING
‚îî‚îÄ‚îÄ statistical_gates.py        ‚è≥ PENDING

tests/tuning/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ test_allen_dynes_corrections.py  ‚úÖ IMPLEMENTED (148 lines, 13/13 tests pass)
‚îú‚îÄ‚îÄ test_mu_star_optimizer.py        ‚è≥ PENDING
‚îî‚îÄ‚îÄ test_statistical_gates.py        ‚è≥ PENDING

config/
‚îî‚îÄ‚îÄ mu_star.v0_5_0.yaml  ‚è≥ PENDING (will be generated by optimizer)
```

---

### STEP 1: Exact Allen-Dynes f‚ÇÅ/f‚ÇÇ ‚úÖ
**Status**: 100% Complete, Production-Ready

**Implementation**: EXACT Allen & Dynes (1975) Phys. Rev. B 12, 905, Eq. 3

**Core Functions**:
1. ‚úÖ `compute_f1_factor(Œª, Œº*)` - Strong-coupling renormalization
   - Formula: f‚ÇÅ = [1 + (Œª/Œõ‚ÇÅ)^(3/2)]^(1/3)
   - Œõ‚ÇÅ(Œº*) = 2.46(1 + 3.8Œº*)
   - Effect: Boosts Tc for Œª > 1.0 by ~10-30%

2. ‚úÖ `compute_f2_factor(Œª, Œº*, r)` - Spectral shape correction
   - Formula: f‚ÇÇ = 1 + [(r¬≤ - 1)Œª¬≤] / [Œª¬≤ + Œõ‚ÇÇ¬≤]
   - Œõ‚ÇÇ(Œº*, r) = 1.82(1 + 6.3Œº*) √ó r (Œº*-dependent!)
   - r ‚â° ‚ü®œâ¬≤‚ü©^(1/2) / œâ_log (phonon spectrum width)

3. ‚úÖ `allen_dynes_corrected_tc()` - Full Tc with f‚ÇÅ/f‚ÇÇ
   - Tc = (œâ_log/1.2) √ó f‚ÇÅ √ó f‚ÇÇ √ó exp[-1.04(1+Œª)/(Œª-Œº*(1+0.62Œª))]
   - Returns: {Tc, f1_factor, f2_factor, warnings}

4. ‚úÖ `OMEGA2_RATIO_DB` - Material-specific r values (21 materials)
   - Simple metals (Al, Pb): 1.15-1.25
   - A15 compounds (Nb3Sn): 1.60-1.70
   - MgB2 (bimodal): 2.80
   - Default: 1.50

5. ‚úÖ `get_omega2_ratio(material)` - Waterfall: DB ‚Üí default

**Physics Constraints** (All Enforced):
- ‚úÖ œâ_log > 0 (hard guard, raises ValueError)
- ‚úÖ Œª ‚àà [0.1, 3.5] (clipped + warned)
- ‚úÖ Œº* ‚àà [0.08, 0.20] (clipped + warned)
- ‚úÖ f‚ÇÇ ‚àà [1.0, 1.5] (physical bounds)
- ‚úÖ Denominator > 0 (unphysical check)
- ‚úÖ Extreme spectrum warning (r > 3.5)

**Test Suite**: ‚úÖ **13/13 PASSED** (100%)
```
tests/tuning/test_allen_dynes_corrections.py::test_f1_monotonicity_in_lambda PASSED
tests/tuning/test_allen_dynes_corrections.py::test_f2_bounds PASSED
tests/tuning/test_allen_dynes_corrections.py::test_mu_star_monotonicity PASSED
tests/tuning/test_allen_dynes_corrections.py::test_allen_dynes_tc_increases_with_lambda PASSED
tests/tuning/test_allen_dynes_corrections.py::test_allen_dynes_warning_for_large_lambda PASSED
tests/tuning/test_allen_dynes_corrections.py::test_omega2_ratio_sanity PASSED
tests/tuning/test_allen_dynes_corrections.py::test_omega_log_guard PASSED
tests/tuning/test_allen_dynes_corrections.py::test_extreme_spectrum_warning PASSED
tests/tuning/test_allen_dynes_corrections.py::test_f1_factor_range PASSED
tests/tuning/test_allen_dynes_corrections.py::test_denominator_guard PASSED
tests/tuning/test_allen_dynes_corrections.py::test_tc_positive PASSED
tests/tuning/test_allen_dynes_corrections.py::test_determinism PASSED
tests/tuning/test_allen_dynes_corrections.py::test_comparison_with_known_values PASSED
```

**Test Coverage**:
- ‚úÖ f‚ÇÅ/f‚ÇÇ monotonicity (Œª, Œº*)
- ‚úÖ Physics bounds validation
- ‚úÖ Edge case guards (œâ_log ‚â§ 0, denominator ‚â§ 0)
- ‚úÖ Warning triggers (Œª > 1.5, r > 3.5)
- ‚úÖ Determinism (identical results)
- ‚úÖ Known value comparison (Nb: ~9.25K experimental)

**Micro-Edits Integrated**:
- ‚úÖ Micro-edit #6: œâ_log > 0 guard + extreme spectrum warning
- ‚úÖ Micro-edit #8: OMEGA2_RATIO_DB provenance note
- ‚úÖ Micro-edit #8a: Unknown material ‚Üí default ratio test

**Ready for Integration**: ‚úÖ YES
- Can be imported into `structure_utils.py` immediately
- No breaking changes to existing API
- All tests passing, deterministic

---

## üîÑ REMAINING WORK (Steps 2-7)

### STEP 2: Bayesian Œº* Optimization + LOMO
**Status**: Implementation ready (see prompt for complete code)

**Key Components**:
- `create_objective_function()` - MAPE objective with physics penalties
- `optimize_mu_star()` - Bayesian optimization (80 calls, seed=42)
- `lomo_validation()` - Leave-one-material-out anti-overfit
- CLI: `python -m app.src.htc.calibration tune-mu-star`
- Output: `config/mu_star.v0_5_0.yaml`

**Micro-Edits**:
- ‚úÖ Micro-edit #1: Thread env vars at top of calibration.py
- ‚úÖ Micro-edit #2: YAML config validation in run()
- ‚úÖ Micro-edit #4: Full deterministic BO config (noise=1e-10)

### STEP 3: Statistical Gates (Bootstrap CI + MAE)
**Status**: Implementation ready

**Key Components**:
- `compute_delta_mape_ci()` - Stratified bootstrap (1000 resamples)
- CLI: `python -m app.src.htc.calibration validate-gates-v05`
- Decision aid: MAE ‚â•0.5K compensates borderline MAPE

**Micro-Edits**:
- ‚úÖ Micro-edit #3: MAE decision aid for borderline MAPE
- ‚úÖ Micro-edit #7: Use v0.4.4 as canonical ŒîMAPE baseline

### STEP 4: Prometheus Extensions
**Status**: Needs integration

**Additions**:
- `htc_f1_avg_unitless` per tier
- `htc_f2_avg_unitless` per tier
- Unit labels in HELP lines

**Micro-Edits**:
- ‚úÖ Micro-edit #3: Pass predictions list to writer
- ‚úÖ Micro-edit #4: Symbol clarity (Œò_D, œâ_log)

### STEP 5: Tests
**Status**: Template ready, needs implementation

**Required**:
- `test_mu_star_optimizer.py` - BO + LOMO tests
- `test_statistical_gates.py` - CI + MAE tests
- Determinism suite (3 identical runs)

### STEP 6: Execution Runbook
**Status**: Template provided in prompt

**Fill with actual results**:
- Œº* optimization output
- Calibration metrics (v0.5.0 vs v0.4.4)
- Statistical gate results
- LOMO validation

### STEP 7: Documentation
**Status**: Template provided in prompt

**Updates needed**:
- `docs/HTC_PHYSICS_GUIDE.md` - v0.5.0 section
- `docs/CALIBRATION_LOG.md` - v0.5.0 entry
- Symbol consistency (Œò_D for Debye, œâ_log for log-avg)

---

## üìä SESSION STATISTICS

**Duration**: ~1 hour (STEP 0-1)  
**Git Branch**: `v0.5.0-accuracy-tuning`  
**Files Created**: 9  
**Lines Written**: ~370 (220 implementation + 148 tests)  
**Tests**: 13/13 PASSED ‚úÖ  
**Dependencies Added**: 2 (scikit-optimize, pyyaml)  
**TODO Completion**: 2/9 (22%)  

**Quality Indicators**:
- ‚úÖ Test-first development (TDD)
- ‚úÖ 100% test pass rate
- ‚úÖ Physics constraints enforced
- ‚úÖ Deterministic (seed=42)
- ‚úÖ Comprehensive docstrings
- ‚úÖ Edge case handling

---

## üöÄ NEXT SESSION PLAN

**Priority 1: Complete STEP 2** (Œº* optimization)
1. Implement `mu_star_optimizer.py` (as per prompt)
2. Add CLI hook to `calibration.py`
3. Add runtime YAML loader
4. Write tests
5. Run optimization: `python -m app.src.htc.calibration tune-mu-star`
6. Verify `config/mu_star.v0_5_0.yaml` generated

**Priority 2: Integration** (STEP 3-4)
1. Integrate Allen-Dynes into `structure_utils.py`
2. Add statistical gates CLI
3. Extend Prometheus metrics
4. Run full calibration with f‚ÇÅ/f‚ÇÇ

**Priority 3: Validation** (STEP 5-6)
1. Write remaining tests
2. Execute runbook, fill with actual results
3. Verify ŒîMAPE CI < 0 gate

**Priority 4: Documentation & Commit** (STEP 7-8)
1. Update GUIDE.md + LOG.md
2. Commit with comprehensive message
3. Create PR for review

**Estimated Time**: 3-4 hours for Steps 2-8

---

## üéØ SUCCESS CRITERIA (Target)

**Primary Gate**: ŒîMAPE 95% CI excludes 0 (vs v0.4.4 baseline)
**Secondary Gate**: MAE ‚â•0.5K improvement if MAPE borderline

**Expected Improvements** (after full v0.5.0):
- Overall MAPE: 68.6% ‚Üí <60% (target)
- Tier A MAPE: 64.2% ‚Üí <58%
- Tier B MAPE: 33.9% ‚Üí <32%
- f‚ÇÅ avg (Tier B): ~1.1-1.2 (new metric)
- f‚ÇÇ avg (Tier B): ~1.2-1.3 (new metric)

**Physics Validation**:
- 0 violations across all constraints
- No LOMO overfit (LOMO MAPE < 1.5√ó train MAPE)
- Determinism maintained

---

## üìù COMMIT CHECKPOINT

**Current State**: Ready to commit Steps 0-1
**Commit Message Template**:
```
feat(htc): v0.5.0 Session 1 - Exact Allen-Dynes f‚ÇÅ/f‚ÇÇ corrections

Implement EXACT Allen & Dynes (1975) Eq. 3 formulas for strong-coupling
superconductivity. Foundation for v0.5.0 accuracy tuning.

Core Features:
- ‚úÖ compute_f1_factor(): Œõ‚ÇÅ(Œº*) renormalization (exact)
- ‚úÖ compute_f2_factor(): Œõ‚ÇÇ(Œº*, r) spectral shape (Œº*-dependent)
- ‚úÖ allen_dynes_corrected_tc(): Full Tc with f‚ÇÅ/f‚ÇÇ
- ‚úÖ OMEGA2_RATIO_DB: 21 materials + provenance note
- ‚úÖ Physics guards: œâ_log > 0, extreme spectrum warnings

Test Suite: ‚úÖ 13/13 PASSED (100%)
- f‚ÇÅ/f‚ÇÇ monotonicity (Œª, Œº*)
- Physics bounds validation
- Edge case guards (denominator, œâ_log ‚â§ 0)
- Warning triggers (Œª > 1.5, r > 3.5)
- Determinism + known value comparison

Physics Constraints (Enforced):
- œâ_log > 0 (ValueError if violated)
- Œª ‚àà [0.1, 3.5]
- Œº* ‚àà [0.08, 0.20]
- f‚ÇÇ ‚àà [1.0, 1.5]
- Denominator > 0 check

Micro-Edits Integrated:
- #6: œâ_log domain guard + extreme spectrum warning
- #8: OMEGA2_RATIO_DB provenance note
- #8a: Unknown material ‚Üí default ratio

Dependencies:
- scikit-optimize==0.9.0 (pinned for determinism)
- pyyaml>=6.0 (config persistence)

Refs:
- Allen & Dynes (1975), DOI: 10.1103/PhysRevB.12.905
- Grimvall (1981), ISBN: 0-444-86105-6

Next: STEP 2 (Œº* optimization) + integration
```

**Files to Commit**:
- pyproject.toml (dependencies)
- app/src/htc/tuning/__init__.py
- app/src/htc/tuning/allen_dynes_corrections.py
- tests/tuning/__init__.py
- tests/tuning/test_allen_dynes_corrections.py
- V050_PROGRESS_SESSION1.md (this file)

---

‚úÖ **SESSION 1 COMPLETE** - Solid foundation for v0.5.0 accuracy tuning!
