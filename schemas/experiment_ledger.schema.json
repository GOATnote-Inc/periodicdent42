{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Experiment Ledger Schema",
  "description": "Uncertainty telemetry for epistemic CI runs with information-theoretic metrics",
  "type": "object",
  "required": [
    "run_id",
    "timestamp",
    "commit_sha",
    "branch",
    "tests_selected",
    "tests_total",
    "information_gained_bits",
    "budget_sec",
    "budget_usd",
    "walltime_sec",
    "cost_usd",
    "tests"
  ],
  "properties": {
    "run_id": {
      "type": "string",
      "description": "Unique identifier for this CI run (UUID or commit SHA prefix)",
      "pattern": "^[a-f0-9]{7,40}$"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp of run (ISO 8601)"
    },
    "commit_sha": {
      "type": "string",
      "description": "Full git commit SHA",
      "pattern": "^[a-f0-9]{40}$"
    },
    "branch": {
      "type": "string",
      "description": "Git branch name"
    },
    "tests_selected": {
      "type": "integer",
      "description": "Number of tests selected by epistemic CI",
      "minimum": 0
    },
    "tests_total": {
      "type": "integer",
      "description": "Total number of tests in suite",
      "minimum": 1
    },
    "information_gained_bits": {
      "type": "number",
      "description": "Total information gained (Shannon entropy, bits)",
      "minimum": 0
    },
    "information_possible_bits": {
      "type": "number",
      "description": "Maximum possible information from full suite (bits)",
      "minimum": 0
    },
    "efficiency_bits_per_dollar": {
      "type": "number",
      "description": "Epistemic efficiency: information gained per dollar spent",
      "minimum": 0
    },
    "budget_sec": {
      "type": "number",
      "description": "Time budget constraint (seconds)",
      "minimum": 0
    },
    "budget_usd": {
      "type": "number",
      "description": "Cost budget constraint (USD)",
      "minimum": 0
    },
    "walltime_sec": {
      "type": "number",
      "description": "Actual walltime used (seconds)",
      "minimum": 0
    },
    "cost_usd": {
      "type": "number",
      "description": "Actual cost incurred (USD)",
      "minimum": 0
    },
    "detection_rate": {
      "type": "number",
      "description": "Failure detection rate (failures found / total expected)",
      "minimum": 0,
      "maximum": 1
    },
    "seed": {
      "type": ["integer", "null"],
      "description": "Random seed for reproducibility (null if not set)"
    },
    "env_hash": {
      "type": "string",
      "description": "Hash of environment configuration for reproducibility",
      "pattern": "^[a-f0-9]{16}$"
    },
    "tests": {
      "type": "array",
      "description": "Per-test epistemic metrics",
      "items": {
        "type": "object",
        "required": ["name", "selected", "duration_sec", "cost_usd", "result"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Test identifier (pytest node ID)"
          },
          "suite": {
            "type": "string",
            "description": "Test suite or domain (materials, protein, robotics, generic)"
          },
          "selected": {
            "type": "boolean",
            "description": "Whether this test was selected by epistemic CI"
          },
          "duration_sec": {
            "type": "number",
            "description": "Test execution time (seconds)",
            "minimum": 0
          },
          "cost_usd": {
            "type": "number",
            "description": "Test execution cost (USD)",
            "minimum": 0
          },
          "result": {
            "type": "string",
            "enum": ["pass", "fail", "skip", "error"],
            "description": "Test outcome"
          },
          "failure_type": {
            "type": "string",
            "enum": ["assertion", "timeout", "exception", "numerical", "flaky"],
            "description": "Failure classification (if result=fail)"
          },
          "model_uncertainty": {
            "type": "number",
            "description": "Predicted failure probability [0,1] from ML model",
            "minimum": 0,
            "maximum": 1
          },
          "eig_bits": {
            "type": "number",
            "description": "Expected Information Gain (Bernoulli entropy, bits)",
            "minimum": 0,
            "maximum": 1
          },
          "eig_rank": {
            "type": "integer",
            "description": "Rank by EIG (1=highest information)",
            "minimum": 1
          },
          "metrics": {
            "type": "object",
            "description": "Domain-specific metrics (convergence error, binding affinity, etc.)",
            "additionalProperties": true
          }
        }
      }
    },
    "selection_strategy": {
      "type": "string",
      "enum": ["epistemic", "full", "random", "coverage", "manual"],
      "description": "Strategy used for test selection"
    },
    "ml_model_version": {
      "type": "string",
      "description": "ML model identifier (e.g., selector-v1.pkl)"
    },
    "ml_model_f1": {
      "type": ["number", "null"],
      "description": "ML model F1 score on test set (null if stub model)"
    }
  }
}
