{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://periodic.labs/dtp/v1.0/schema.json",
  "title": "Discovery Trace Protocol (DTP)",
  "description": "Schema for tracking experimental discovery lineage in R&D systems",
  "type": "object",
  "required": [
    "schema_version",
    "hypothesis_id",
    "hypothesis_text",
    "inputs",
    "plan",
    "execution",
    "observations",
    "uncertainty",
    "validation",
    "provenance"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "description": "DTP schema version (e.g., '1.0')"
    },
    "hypothesis_id": {
      "type": "string",
      "pattern": "^HYP-\\d{8}-\\d{3}$",
      "description": "Unique hypothesis identifier (e.g., 'HYP-20251008-001')"
    },
    "hypothesis_text": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Natural language hypothesis statement"
    },
    "inputs": {
      "type": "object",
      "required": ["dataset_id", "model_hash"],
      "properties": {
        "dataset_id": {
          "type": "string",
          "description": "Dataset identifier (versioned, checksummed)"
        },
        "model_hash": {
          "type": "string",
          "description": "Model/method version hash (SHA-256)"
        },
        "instrument_config": {
          "type": "object",
          "description": "Physical instrument configuration (optional)",
          "additionalProperties": true
        }
      }
    },
    "plan": {
      "type": "object",
      "required": ["doe_method"],
      "properties": {
        "doe_method": {
          "type": "string",
          "enum": ["EIG", "grid", "bayes", "random", "adaptive", "manual"],
          "description": "Design of Experiments method"
        },
        "controls": {
          "type": "object",
          "description": "Experimental controls (parameters, bounds, constraints)",
          "additionalProperties": true
        }
      }
    },
    "execution": {
      "type": "object",
      "required": ["start_ts", "end_ts"],
      "properties": {
        "start_ts": {
          "type": "string",
          "format": "date-time",
          "description": "Execution start timestamp (ISO 8601)"
        },
        "end_ts": {
          "type": "string",
          "format": "date-time",
          "description": "Execution end timestamp (ISO 8601)"
        },
        "robot_recipe_hash": {
          "type": "string",
          "description": "Lab robot recipe/program hash (optional)"
        }
      }
    },
    "observations": {
      "type": "object",
      "required": ["summary_metrics"],
      "properties": {
        "raw_refs": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "References to raw data files (paths, URIs, or hashes)"
          }
        },
        "summary_metrics": {
          "type": "object",
          "description": "Summary metrics from observations",
          "properties": {
            "accuracy": {"type": "number", "minimum": 0, "maximum": 1},
            "ece": {"type": "number", "minimum": 0, "maximum": 1},
            "brier": {"type": "number", "minimum": 0, "maximum": 1},
            "coverage": {"type": "number", "minimum": 0, "maximum": 1},
            "entropy_delta_mean": {"type": "number"}
          },
          "additionalProperties": true
        }
      }
    },
    "uncertainty": {
      "type": "object",
      "required": ["pre_bits", "post_bits", "delta_bits"],
      "properties": {
        "pre_bits": {
          "type": "number",
          "minimum": 0,
          "description": "Predictive uncertainty before experiment (bits)"
        },
        "post_bits": {
          "type": "number",
          "minimum": 0,
          "description": "Predictive uncertainty after experiment (bits)"
        },
        "delta_bits": {
          "type": "number",
          "description": "Uncertainty reduction (pre - post, positive = learning)"
        }
      }
    },
    "validation": {
      "type": "object",
      "required": ["human_tag"],
      "properties": {
        "human_tag": {
          "type": "string",
          "enum": ["confirmed", "replicated", "refuted", "needs_review", "auto_default"],
          "description": "Human-in-the-loop validation tag"
        },
        "notes": {
          "type": "string",
          "description": "Validation notes from scientist"
        },
        "user": {
          "type": "string",
          "format": "email",
          "description": "Validator email"
        },
        "validated_at": {
          "type": "string",
          "format": "date-time",
          "description": "Validation timestamp"
        }
      }
    },
    "provenance": {
      "type": "object",
      "required": ["git_sha", "ci_run_id"],
      "properties": {
        "git_sha": {
          "type": "string",
          "pattern": "^[0-9a-f]{7,40}$",
          "description": "Git commit SHA"
        },
        "ci_run_id": {
          "type": "string",
          "description": "CI run identifier"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Record creation timestamp"
        }
      }
    }
  }
}
