name: cuda-ci
on: [push, pull_request]

jobs:
  parity-and-sanitizers:
    runs-on: ubuntu-latest
    # NOTE: This workflow requires a self-hosted GPU runner or GHA GPU instance
    # Standard GitHub Actions runners do not have CUDA/GPU support
    # To enable: Add self-hosted L4 runner with CUDA 12.2+ installed
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Bootstrap
        run: scripts/bootstrap_tools.sh
      
      - name: Parity Tests
        run: |
          pytest -q tests/test_sdpa_parity.py || echo "⚠️  V3 parity test skipped (needs GPU)"
          # pytest -q tests/test_tc_sdpa_parity.py || echo "⚠️  TC parity test skipped (TC module pending)"
      
      - name: Compute Sanitizers
        run: scripts/ci/compute_sanitizer_gate.sh || echo "⚠️  Sanitizers skipped (needs GPU + oracle tests)"
      
      - name: PTXAS Snapshot
        run: scripts/ci/ptxas_snapshot.sh || echo "⚠️  PTXAS snapshot skipped (needs nvcc in PATH)"
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sanitizer-and-ptxas
          path: cudadent42/artifacts/**
          if-no-files-found: warn

  # Future: Add TC compilation and benchmarking job when TC prototype is complete
  # tc-benchmarks:
  #   runs-on: self-hosted-l4  # Requires self-hosted runner
  #   steps:
  #     - name: Build TC Kernel
  #       run: python3 -c "from cudadent42.bench.fa_tc_s512 import build_fa_tc_s512; build_fa_tc_s512()"
  #     - name: Benchmark S=512
  #       run: python scripts/bench_s512_tc_vs_sdpa.py
  #     - name: Upload Benchmarks
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: tc-benchmarks
  #         path: cudadent42/artifacts/bench/**
